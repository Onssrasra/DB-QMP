<!-- =====================================================
     DB Produktdatenâ€¯Vergleichstool â€“Â index.html
     VersionÂ 2025â€‘08â€‘03Â (optimiert)
====================================================== -->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸš†Â DBÂ ProduktdatenÂ Vergleichstool</title>
  <!-- XLSXÂ â€‘Â nur bei Bedarf wird geparst  -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* 1ï¸âƒ£Â RESET + LAYOUT */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#2c3e50}
    .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden}
    .header{background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%);color:#fff;padding:30px;text-align:center}
    .header h1{font-size:2.5em;margin-bottom:10px;font-weight:300}
    .main-content{display:flex;height:calc(100vh - 200px)}
    .chat-section{flex:1;display:flex;flex-direction:column;border-right:2px solid #ecf0f1}
    .chat-header{background:#3498db;color:#fff;padding:20px;font-size:1.2em;font-weight:700}
    .chat-messages{flex:1;padding:20px;overflow-y:auto;background:#f8f9fa}
    .message{margin-bottom:15px;padding:15px;border-radius:10px;max-width:80%;animation:slideIn .3s ease-out}
    .message.bot{background:#e3f2fd;border-left:4px solid #2196f3;margin-right:auto}
    .message.user{background:#f3e5f5;border-left:4px solid #9c27b0;margin-left:auto}
    .message.system{background:#fff3e0;border-left:4px solid #ff9800;margin:0 auto;text-align:center;font-style:italic}
    @keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .input-section{padding:20px;background:#fff;border-top:1px solid #ecf0f1}
    .file-upload{margin-bottom:15px;padding:15px;border:2px dashed #3498db;border-radius:10px;text-align:center;cursor:pointer;transition:.3s}
    .file-upload:hover{background:#e3f2fd;border-color:#2980b9}
    .file-upload.has-file{border-color:#27ae60;background:#d5f4e6}
    .input-container{display:flex;gap:10px}
    .input-field{flex:1;padding:15px;border:2px solid #ecf0f1;border-radius:25px;font-size:16px;outline:none;transition:border-color .3s}
    .input-field:focus{border-color:#3498db}
    .send-btn{padding:15px 25px;background:#3498db;color:#fff;border:none;border-radius:25px;cursor:pointer;font-size:16px;transition:.3s}
    .send-btn:hover{background:#2980b9}
    .send-btn:disabled{background:#bdc3c7;cursor:not-allowed}
    .results-section{flex:2;display:flex;flex-direction:column;background:#f8f9fa}
    .results-header{background:#27ae60;color:#fff;padding:20px;font-size:1.2em;font-weight:700}
    .results-content{flex:1;padding:20px;overflow-y:auto}
    /* Tabellen */
    .comparison-container{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px}
    .data-table{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 4px 8px rgba(0,0,0,.1)}
    .table-header{padding:15px;font-weight:700;color:#fff}
    .excel-data .table-header{background:#e74c3c}.web-data .table-header{background:#9b59b6}
    .table-content{padding:15px;max-height:400px;overflow-y:auto}
    .data-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #ecf0f1}
    .data-row:last-child{border-bottom:none}
    .data-label{font-weight:700;flex:1}
    .data-value{flex:1;text-align:right}
    .product-link{color:#3498db;text-decoration:none;padding:5px 10px;background:#ecf0f1;border-radius:5px;font-size:.9em;transition:.3s}
    .product-link:hover{background:#3498db;color:#fff}
    .comparison-table{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 4px 8px rgba(0,0,0,.1)}
    .comparison-table .table-header{background:#f39c12}
    .comparison-row{display:grid;grid-template-columns:1fr 1fr 1fr 120px;gap:15px;padding:12px 15px;border-bottom:1px solid #ecf0f1;align-items:center}
    .comparison-row:nth-child(even){background:#f8f9fa}
    .comparison-header{font-weight:700}
    .match-status{padding:5px 10px;border-radius:20px;font-size:12px;font-weight:700;text-align:center}
    .match{background:#d5f4e6;color:#27ae60}.differ{background:#fdeaea;color:#e74c3c}.missing{background:#fff3cd;color:#f39c12}
    /* Loader */
    .loading{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-radius:50%;border-top-color:#3498db;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Responsive */
    @media(max-width:768px){.main-content{flex-direction:column;height:auto}.comparison-container{grid-template-columns:1fr}.comparison-row{grid-template-columns:1fr;gap:5px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸš†Â DBÂ ProduktdatenÂ Vergleichstool</h1>
      <p>Automatischer Vergleich von Siemensâ€‘Produktdaten zwischen Excelâ€‘Tabelle undÂ MyMobase</p>
    </div>

    <div class="main-content">
      <!-- â¬…ï¸  Chatâ€‘Panel -->
      <div class="chat-section">
        <div class="chat-header">ğŸ’¬Â Chatâ€‘Interface</div>
        <div class="chat-messages" id="chatMessages">
          <div class="message bot"><strong>ğŸ¤–Â DBâ€‘Assistent:</strong><br/>Willkommen! Lade zuerst deine Excelâ€‘Tabelle hoch.</div>
        </div>
        <div class="input-section">
          <div class="file-upload" id="fileUpload">
            <input type="file" id="excelFile" accept=".xlsx,.xls" hidden />
            <div id="fileUploadText">ğŸ“Â ExcelÂ ablegen&nbsp;oder klicken<br/><small>.xlsxÂ oderÂ .xls</small></div>
          </div>
          <div class="input-container">
            <input id="messageInput" class="input-field" placeholder="Artikelnummer (z.â€¯B.Â A2V123456)â€¦" disabled />
            <button id="sendBtn" class="send-btn" disabled>Senden</button>
          </div>
        </div>
      </div>

      <!-- â¡ï¸  Ergebnisâ€‘Panel -->
      <div class="results-section">
        <div class="results-header">ğŸ“ŠÂ Vergleichsergebnisse</div>
        <div class="results-content" id="resultsContent">
          <div style="text-align:center;padding:50px;color:#7f8c8d">
            <h3>Bereit fÃ¼r denÂ Vergleich</h3>
            <p>Excelâ€‘Datei hochladen &nbsp;+&nbsp; Artikelnummer eingeben.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- =====================================================
     JavaScript â€“Â Appâ€‘Logik
====================================================== -->
<script>
class ProductComparisonTool {
  constructor(){
    this.excelData=null;this.availableColumns=[];this.columnMapping={};this.currentStep='upload';
    this.setupFileUpload();this.initUIListeners();
  }
  /* ---------- UIÂ Initialisierung ---------- */
  initUIListeners(){
    const btn=document.getElementById('sendBtn');const inp=document.getElementById('messageInput');
    btn.addEventListener('click',()=>this.handleUserInput());
    inp.addEventListener('keypress',e=>e.key==='Enter'&&this.handleUserInput());
  }
  setupFileUpload(){
    const box=document.getElementById('fileUpload');const input=document.getElementById('excelFile');
    box.addEventListener('click',()=>input.click());
    ['dragover','dragleave','drop'].forEach(evt=>box.addEventListener(evt,e=>e.preventDefault()));
    box.addEventListener('drop',e=>e.dataTransfer.files[0]&&this.handleFileUpload(e.dataTransfer.files[0]));
    input.addEventListener('change',e=>e.target.files[0]&&this.handleFileUpload(e.target.files[0]));
  }
  /* ---------- Chatâ€‘Helpers ---------- */
  addMessage(html,type='bot'){
    const wrap=document.getElementById('chatMessages');const div=document.createElement('div');div.className=`message ${type}`;
    div.innerHTML=type==='bot'?`<strong>ğŸ¤–Â DBâ€‘Assistent:</strong><br/>${html}`:type==='user'?`<strong>ğŸ‘¤Â Sie:</strong><br/>${html}`:html;
    wrap.appendChild(div);wrap.scrollTop=wrap.scrollHeight;
  }
  addProgress(msg){const wrap=document.getElementById('chatMessages');const div=document.createElement('div');div.className='message system';div.innerHTML=`<div class="loading"></div><span style="margin-left:10px">${msg}</span>`;wrap.appendChild(div);wrap.scrollTop=wrap.scrollHeight;return div;}
  updateProgress(el,msg,done=false){el.innerHTML=done?`âœ…Â ${msg}`:`<div class="loading"></div><span style="margin-left:10px">${msg}</span>`;if(done)el.style.background='#d5f4e6';}

  /* ---------- Dateiâ€‘Handling ---------- */
  async handleFileUpload(file){
    if(!/\.(xlsx|xls)$/i.test(file.name)){this.addMessage('âŒÂ UngÃ¼ltigesâ€¯Excelâ€‘Format','.system');return;}
    const prog=this.addProgress('ExcelÂ wird geladenâ€¦');
    try{const data=await this.readExcel(file);this.excelData=data;this.analyseColumns(data);
      this.updateProgress(prog,`Excel geladen (${data.length}Â Zeilen)`,true);
      document.getElementById('fileUpload').classList.add('has-file');document.getElementById('fileUploadText').innerHTML=`âœ…Â ${file.name}<br/><small>${data.length}Â Produkte</small>`;
      document.getElementById('messageInput').disabled=false;document.getElementById('sendBtn').disabled=false;this.currentStep='search';
    }catch(e){this.updateProgress(prog,'Fehler beim Laden',true);this.addMessage(`âŒÂ ${e.message}`,'system');}
  }
  readExcel(file){
    return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=e=>{try{const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});const ws=wb.Sheets[wb.SheetNames[0]];const raw=XLSX.utils.sheet_to_json(ws,{header:1});if(raw.length<4)throw new Error('Zu wenig Zeilen');const headers=raw[2];const rows=raw.slice(3).map(r=>{const o={};headers.forEach((h,i)=>h&&(o[h.trim()]=r[i]||''));return o;}).filter(o=>Object.values(o).some(v=>v&&v.toString().trim()!==''));res(rows);}catch(err){rej(err);}};fr.onerror=()=>rej(new Error('Lesefehler'));fr.readAsArrayBuffer(file);});
  }
  /* ---------- Column Mapping ---------- */
  analyseColumns(data){if(!data.length)return;data.forEach(r=>Object.keys(r).forEach(k=>this.availableColumns.includes(k)||this.availableColumns.push(k)));
    const map={};this.availableColumns.forEach(c=>{if(!c)return;const lc=c.toLowerCase();
      if(/siemens mobility materialnummer/i.test(c))map.siemensMobilityNumber=c;
      if(/materialkurztext|maktx/i.test(lc))map.materialDescription=c;
      if(/her\.?-?artikelnummer|herstellerartikelnummer/i.test(lc))map.manufacturerNumber=c;
      if(lc==='lÃ¤nge')map.length=c;if(lc==='breite')map.width=c;if(lc==='hÃ¶he')map.height=c;
      if(/nettogewicht/.test(lc))map.netWeight=c;if(/bruttogewicht/.test(lc))map.grossWeight=c;
      if(lc==='werkstoff')map.material=c;if(/fert\.|prÃ¼fhinweis|fertigungshinweis/.test(lc))map.manufacturingNote=c;
      if(/einheit.*abmass/.test(lc))map.dimensionUnit=c;if(/einheit.*gewicht/.test(lc))map.weightUnit=c;
      if(c==='MATNM')map.materialNumber=c;});this.columnMapping=map;this.addMessage('âœ…Â ExcelÂ analysiert â€“Â Artikelnummer eingeben.');}

  /* ---------- UserÂ Input ---------- */
  handleUserInput(){const inp=document.getElementById('messageInput');const val=inp.value.trim();if(!val)return;if(this.currentStep!=='search'){this.addMessage('Bitte zuerst eine Excelâ€‘Datei laden.','system');return;}
    this.addMessage(val,'user');inp.value='';this.processSearch(val);
  }

  /* ---------- Suche & Vergleich ---------- */
  async processSearch(num){const findMsg=this.addProgress('Suche in Excelâ€¦');const excelRow=this.excelData.find(r=>Object.values(r).some(v=>v&&v.toString().toUpperCase().trim()===num.toUpperCase().trim()));
    this.updateProgress(findMsg,excelRow?'Produkt gefunden':'Nicht gefunden',true);if(!excelRow)return;
    /*Â Webâ€‘AbfrageÂ */const webMsg=this.addProgress('Hole Webâ€‘Datenâ€¦');let webData;try{const resp=await fetch('/api/scrape',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({articleNumber:num})});webData=(await resp.json()).data;this.updateProgress(webMsg,'Webâ€‘Daten geladen',true);}catch(e){this.updateProgress(webMsg,'Webâ€‘Fehler',true);webData={Herstellerartikelnummer:num,Produkttitel:'Fehler',Abmessung:'Nicht gefunden',Gewicht:'Nicht gefunden'};}
    /*Â Vergleich anzeigenÂ */this.buildResult(excelRow,webData,num);
  }

  buildResult(excel,web,num){const wrap=document.getElementById('resultsContent');wrap.innerHTML=`<h3 style="margin-bottom:20px">ğŸ”Â Ergebnis fÃ¼rÂ ${num}</h3>`+
      `<div class="comparison-container"><div class="data-table excel-data"><div class="table-header">ğŸ“ŠÂ Excel</div><div class="table-content">${this.renderDataTable(excel,'excel')}</div></div>`+
      `<div class="data-table web-data"><div class="table-header">ğŸŒÂ Web</div><div class="table-content">${this.renderDataTable(web,'web')}</div></div></div>`+
      `<div class="comparison-table"><div class="table-header">âš–ï¸Â Vergleich</div><div class="table-content">${this.renderComparison(excel,web)}</div></div>`;
  }

  /* ---------- Rendering Helpers ---------- */
  renderDataTable(data,src){let html='';if(src==='excel'){
      const fields=[
        {key:'siemensMobilityNumber',label:'Siemens Mobility Materialnummer'},
        {key:'materialDescription', label:'Material-Kurztext'},
        {key:'manufacturerNumber',  label:'Herstellerartikelnummer'},
        {key:'grossWeight', label:'Bruttogewicht',withUnit:true},
        {key:'netWeight',   label:'Nettogewicht', withUnit:true},
        {key:'length',      label:'LÃ¤nge',addUnit:true},
        {key:'width',       label:'Breite',addUnit:true},
        {key:'height',      label:'HÃ¶he', addUnit:true},
        {key:'manufacturingNote',label:'Fertigung/PrÃ¼fhinweis'},
        {key:'material',label:'Werkstoff'}];
      fields.forEach(f=>{let v=this.getExcelFieldValue(data,f.key);if(v||v===0){let disp=this.format(v);
        if(f.addUnit){const u=this.getExcelFieldValue(data,'dimensionUnit')||'mm';disp+=` ${u}`;}
        if(f.withUnit){const u=this.getExcelFieldValue(data,'weightUnit')||'kg';disp+=` ${u.toUpperCase()}`;}
        html+=`<div class="data-row"><div class="data-label">${f.label}:</div><div class="data-value">${disp}</div></div>`;}});
    }else{
      const fields=[{key:'Herstellerartikelnummer',label:'A2Vâ€‘Nummer'},{key:'Produkttitel',label:'Produktname'},{key:'Abmessung',label:'Abmessung'},{key:'Gewicht',label:'Gewicht'},{key:'Werkstoff',label:'Werkstoff'},{key:'Materialklassifizierung',label:'Materialklassifizierung'},{key:'Statistische Warennummer',label:'Statistische Warennummer'},{key:'URL',label:'Link',link:true}];
      fields.forEach(f=>{let v=data[f.key]||'Nicht gefunden';if(f.link&&v!=='Nicht gefunden')v=`<a class="product-link" target="_blank" href="${v}">ğŸ”—Â Open</a>`;html+=`<div class="data-row"><div class="data-label">${f.label}:</div><div class="data-value">${v}</div></div>`;});}
    return html;
  }

  renderComparison(excel,web){const rows=[
      {e:'siemensMobilityNumber',w:'Herstellerartikelnummer',label:'Siemens Mobility Materialnummer'},
      {e:'materialDescription', w:'Produkttitel',label:'Material-Kurztext / Produktname'},
      {e:'netWeight',          w:'Gewicht',label:'Gewicht'},
      {e:'dimensions',         w:'Abmessung',label:'Abmessung',dim:true},
      {e:'material',           w:'Werkstoff',label:'Werkstoff'},
      {e:'manufacturingNote',  w:'Materialklassifizierung',label:'Fert./PrÃ¼fhinweis / Materialklassifizierung'}];
    let html=`<div class="comparison-row comparison-header"><div>Eigenschaft</div><div>Excel</div><div>Web</div><div>Bewertung</div></div>`;
    rows.forEach(r=>{
      let ev=r.dim?this.combineExcelDimensions(excel):this.getExcelFieldValue(excel,r.e)||'-';
      let wv=web[r.w]||'-';if(r.dim===true)wv=wv;
      const res=this.compare(ev,wv);
      html+=`<div class="comparison-row"><div><strong>${r.label}</strong></div><div>${this.format(ev)}</div><div>${this.format(wv)}</div><div class="match-status ${res.status}">${res.text}</div></div>`;});
    return html;
  }

  /* ---------- Vergleich & Utils ---------- */
  compare(v1,v2){const NA=['-','',"Nicht gefunden","Nicht verfÃ¼gbar"];if(NA.includes(v1)&&NA.includes(v2))return{status:'missing',text:'Beide fehlend'};if(NA.includes(v1))return{status:'missing',text:'Excel fehlend'};if(NA.includes(v2))return{status:'missing',text:'Web fehlend'};
    if(this.isNum(v1)&&this.isNum(v2)){const n1=parseFloat(v1.toString().replace(',','.'));const n2=parseFloat(v2.toString().replace(',','.'));return Math.abs(n1-n2)<=Math.max(n1,n2)*.01?{status:'match',text:'Identisch'}:{status:'differ',text:'Verschieden'};}
    const clean=s=>s.toString().replace(/\s+/g,'').toUpperCase();return clean(v1)===clean(v2)?{status:'match',text:'Identisch'}:{status:'differ',text:'Verschieden'};}
  isNum(v){return !isNaN(parseFloat(v))&&isFinite(v);} format(v){return v===null||v===undefined||v===''?'<em>N/A</em>':this.isNum(v)?(parseFloat(v)%1===0?parseFloat(v).toString():parseFloat(v).toFixed(2)):v;}
  /* Excelâ€‘Helper */
  getExcelFieldValue(o,k){if(!this.columnMapping)return null;const m=this.columnMapping[k];return m?o[m]:null;}
}
window.addEventListener('DOMContentLoaded',()=>new ProductComparisonTool());
</script>
</body>
</html>
